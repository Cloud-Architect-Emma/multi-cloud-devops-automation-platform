pipeline {
    agent any

    environment {
        // AWS
        AWS_CREDENTIALS = credentials('aws-terraform')
        AWS_DEFAULT_REGION = 'us-east-1'

        // Azure
        AZURE_CLIENT_ID = credentials('azure-terraform').username
        AZURE_CLIENT_SECRET = credentials('azure-terraform').password
        AZURE_TENANT_ID = credentials('azure-terraform').tenant
        AZURE_SUBSCRIPTION_ID = credentials('azure-terraform').subscriptionId

        // GCP
        GCP_KEY_FILE = credentials('gcp-terraform')

        // Docker
        DOCKERHUB_CREDS = credentials('dockerhub')

        // SonarQube
        SONAR_TOKEN = credentials('sonarqube')

        // ArgoCD
        ARGOCD_TOKEN = credentials('argocd')
        ARGOCD_SERVER = 'https://argocd.example.com'
    }

    options {
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '10'))
        skipDefaultCheckout(true)
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Terraform Init & Plan') {
            parallel {
                stage('AWS Terraform') {
                    steps {
                        withAWS(credentials: 'aws-terraform', region: "${env.AWS_DEFAULT_REGION}") {
                            dir('infrastructure-live/aws') {
                                sh 'terraform init'
                                sh 'terraform plan -out=tfplan'
                            }
                        }
                    }
                }

                stage('Azure Terraform') {
                    steps {
                        dir('infrastructure-live/azure') {
                            sh """
                            az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
                            az account set --subscription $AZURE_SUBSCRIPTION_ID
                            terraform init
                            terraform plan -out=tfplan
                            """
                        }
                    }
                }

                stage('GCP Terraform') {
                    steps {
                        withCredentials([file(credentialsId: 'gcp-terraform', variable: 'GCP_KEYFILE')]) {
                            dir('infrastructure-live/gcp') {
                                sh 'gcloud auth activate-service-account --key-file=$GCP_KEYFILE'
                                sh 'terraform init'
                                sh 'terraform plan -out=tfplan'
                            }
                        }
                    }
                }
            }
        }

        stage('Terraform Apply') {
            parallel {
                stage('AWS Apply') {
                    steps {
                        withAWS(credentials: 'aws-terraform', region: "${env.AWS_DEFAULT_REGION}") {
                            dir('infrastructure-live/aws') {
                                sh 'terraform apply -auto-approve tfplan'
                            }
                        }
                    }
                }

                stage('Azure Apply') {
                    steps {
                        dir('infrastructure-live/azure') {
                            sh 'terraform apply -auto-approve tfplan'
                        }
                    }
                }

                stage('GCP Apply') {
                    steps {
                        withCredentials([file(credentialsId: 'gcp-terraform', variable: 'GCP_KEYFILE')]) {
                            dir('infrastructure-live/gcp') {
                                sh 'terraform apply -auto-approve tfplan'
                            }
                        }
                    }
                }
            }
        }

        stage('Build, Scan & Push Docker Image') {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', 'dockerhub') {
                        def appImage = docker.build("multi-cloud-app:${env.BUILD_NUMBER}")
                        
                        // Trivy security scan (fail on critical)
                        sh """
                        trivy image --exit-code 1 --severity CRITICAL,HIGH ${appImage.imageName()}
                        """
                        
                        // Push if scan passes
                        appImage.push()
                    }
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('sonarqube') {
                    sh 'sonar-scanner -Dsonar.login=$SONAR_TOKEN'
                }
            }
        }

        stage('Deploy to Kubernetes via ArgoCD') {
            steps {
                script {
                    def clusters = ['aws', 'azure', 'gcp']
                    clusters.each { cluster ->
                        sh """
                        argocd login $ARGOCD_SERVER --token $ARGOCD_TOKEN --insecure
                        argocd app sync app-${cluster} --prune --retry
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully. All clouds are up-to-date.'
        }
        failure {
            echo 'Pipeline failed! Rolling back deployments...'
            script {
                def clusters = ['aws', 'azure', 'gcp']
                clusters.each { cluster ->
                    sh """
                    argocd login $ARGOCD_SERVER --token $ARGOCD_TOKEN --insecure
                    argocd app rollback app-${cluster} 1
                    """
                }
            }
        }
    }
}
